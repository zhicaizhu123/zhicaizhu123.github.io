# 错误操作和冲突补救方案

## 错误提交/合并/推送的挽救方法
- 场景一： 未将修改内容提交到错误的分支    
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e8640a2c02117?w=1349&h=385&f=png&s=132715">![](https://user-gold-cdn.xitu.io/2018/12/26/167e8640a2c02117?w=1349&h=385&f=png&s=132715)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e8664c2712bfd?w=1360&h=653&f=png&s=188496">![](https://user-gold-cdn.xitu.io/2018/12/26/167e8664c2712bfd?w=1360&h=653&f=png&s=188496)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e86fcbe520cb8?w=1357&h=446&f=png&s=135996">![](https://user-gold-cdn.xitu.io/2018/12/26/167e86fcbe520cb8?w=1357&h=446&f=png&s=135996)</a>  
- 场景二： 已将修改内容提交/合并到错误分支， 但未提交到远程库      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e86ad291cc2b4?w=1356&h=586&f=png&s=180730">![](https://user-gold-cdn.xitu.io/2018/12/26/167e86ad291cc2b4?w=1356&h=586&f=png&s=180730)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e86b696f57289?w=1348&h=321&f=png&s=112959">![](https://user-gold-cdn.xitu.io/2018/12/26/167e86b696f57289?w=1348&h=321&f=png&s=112959)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e86c2d6c68e3b?w=1351&h=391&f=png&s=124746">![](https://user-gold-cdn.xitu.io/2018/12/26/167e86c2d6c68e3b?w=1351&h=391&f=png&s=124746)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e86e451dce867?w=1366&h=642&f=png&s=189469">![](https://user-gold-cdn.xitu.io/2018/12/26/167e86e451dce867?w=1366&h=642&f=png&s=189469)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e86fe2f81c26d?w=1357&h=446&f=png&s=135996">![](https://user-gold-cdn.xitu.io/2018/12/26/167e86fe2f81c26d?w=1357&h=446&f=png&s=135996)</a>      
- 场景三： 已经修改的内容提交到错误分支的远程库   
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e8737316043ae?w=1352&h=434&f=png&s=72886">![](https://user-gold-cdn.xitu.io/2018/12/26/167e8737316043ae?w=1352&h=434&f=png&s=72886)</a>       
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e884a3acf9d2a?w=1348&h=475&f=png&s=159258">![](https://user-gold-cdn.xitu.io/2018/12/26/167e884a3acf9d2a?w=1348&h=475&f=png&s=159258)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e884fcd95d1e6?w=1356&h=347&f=png&s=120585">![](https://user-gold-cdn.xitu.io/2018/12/26/167e884fcd95d1e6?w=1356&h=347&f=png&s=120585)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e885ad099bc12?w=1352&h=414&f=png&s=131588">![](https://user-gold-cdn.xitu.io/2018/12/26/167e885ad099bc12?w=1352&h=414&f=png&s=131588)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e874ee501aa4f?w=1349&h=568&f=png&s=176968">![](https://user-gold-cdn.xitu.io/2018/12/26/167e874ee501aa4f?w=1349&h=568&f=png&s=176968)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e8882fa1c31c5?w=1357&h=681&f=png&s=193366">![](https://user-gold-cdn.xitu.io/2018/12/26/167e8882fa1c31c5?w=1357&h=681&f=png&s=193366)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e888e7d22a9f8?w=1360&h=506&f=png&s=146960">![](https://user-gold-cdn.xitu.io/2018/12/26/167e888e7d22a9f8?w=1360&h=506&f=png&s=146960)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e889a5ff98c08?w=1360&h=506&f=png&s=146960">![](https://user-gold-cdn.xitu.io/2018/12/26/167e889a5ff98c08?w=1360&h=506&f=png&s=146960)</a>      
      <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/26/167e88a22eb7c0fd?w=1338&h=703&f=png&s=186601">![](https://user-gold-cdn.xitu.io/2018/12/26/167e88a22eb7c0fd?w=1338&h=703&f=png&s=186601)</a>      

## 冲突和解决方式
#### 冲突出现原因 
当 git 不知道如何自动合并某个文件的多处改动的时候，就会引发冲突。       
一般出现在多人协作中修改了两个或多个开发者修改了同一行代码（编辑冲突）或者对某份代码的几个部分作出了各自的修改的时候 
#### 解决冲突
- 场景一：两个或多个开发人员修改了同一行代码(merge或者pull（fetch + merge）冲突)
    <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3868982f1c7c?w=1352&h=598&f=png&s=157669">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3868982f1c7c?w=1352&h=598&f=png&s=157669)</a>      
    - 使用 “我的版本” 或 “他人版本” 来解决    
        这是修复 git 中的合并冲突最简单的方式。右击任意有冲突的文件     
        <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3c5f2bcda53d?w=1046&h=619&f=png&s=141663">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3c5f2bcda53d?w=1046&h=619&f=png&s=141663)</a>
        选择这种方式解决冲突的情况下，说明你对冲突代码的取舍是明确的。
    - 手动编辑方法解决
        这种方式是在你不能确定是否可以丢弃的另一份代码情况下使用，也是 git 中的合并冲突最灵活的方法。   
        打开编辑器，一般编辑器都会显示冲突所在的位置，和相关小伙伴商量根据需求修改好冲突代码。    
        修改前：    
        <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3c77da6cb319?w=999&h=192&f=png&s=26553">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3c77da6cb319?w=999&h=192&f=png&s=26553)</a>
        修改后：    
        <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3c85f32ddfec?w=914&h=197&f=png&s=20660">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3c85f32ddfec?w=914&h=197&f=png&s=20660)</a>
        修改完后回到SourceTree，在 “未暂存文件” 区域里选择冲突的文件。拖到上面的 “已暂存文件” 区域里面。或者也可以右击文件，然后选择 “解决冲突 -> 标记为已解决”。   
        - 点击“暂存”按钮    
        <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3cb15780c7b5?w=1039&h=546&f=png&s=112640">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3cb15780c7b5?w=1039&h=546&f=png&s=112640)</a>    
        - 标志为已解决    
        <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3c9c0299fc9b?w=1037&h=559&f=png&s=122466">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3c9c0299fc9b?w=1037&h=559&f=png&s=122466)</a>      
    - 合并过程中失误解决方式  
        有时候解决冲突，可能误删了一些东西，想恢复到解决冲突之前的状态，有以下解决方式。
        - 重置所有文件：
            只要没有提交，就可以从顶部菜单中选择 “丢弃”。然后就可以重新开始分支合并操作，一切都将从头来过。    
            <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/18/167c0cb8e39186a3?w=492&h=193&f=png&s=8966">![](https://user-gold-cdn.xitu.io/2018/12/18/167c0cb8e39186a3?w=492&h=193&f=png&s=8966)</a>
        - 重置单个文件：
            右击文件，然后选择 “解决冲突 -> 重新合并”   
    
          
- 场景二： 树冲突，文件删除或者重命名，有一个file.js文件，小伙伴A把文件改名为fileA.js，小伙伴B把同一个文件改名为fileB.js，那么小伙伴B将这两个commit合并时，会产生冲突，如图所示   

    <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2019/1/5/1681b7ea1dbcb216?w=1030&h=294&f=png&s=29098">![](https://user-gold-cdn.xitu.io/2019/1/5/1681b7ea1dbcb216?w=1030&h=294&f=png&s=29098)</a>     
    解决办法： 与小伙伴协商取舍，假如最终确定使用小伙伴B的文件名fileB.js        
    1. 删除file.js 和 fileA.js文件      
    
    <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2019/1/5/1681b821327eb028?w=1146&h=601&f=png&s=110881">![](https://user-gold-cdn.xitu.io/2019/1/5/1681b821327eb028?w=1146&h=601&f=png&s=110881)</a>        
    
    2. 添加fileB.js 到暂缓区        
    
    <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2019/1/5/1681b831b3c4762b?w=1129&h=553&f=png&s=104500">![](https://user-gold-cdn.xitu.io/2019/1/5/1681b831b3c4762b?w=1129&h=553&f=png&s=104500)</a>        
    3. 提交推送     
    
    <a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2019/1/5/1681b847bcb44ef9?w=1350&h=676&f=png&s=81577">![](https://user-gold-cdn.xitu.io/2019/1/5/1681b847bcb44ef9?w=1350&h=676&f=png&s=81577)</a>
    4. 小伙伴A拉取最新代码      

## 减少代码冲突的措施
- 容易产生冲突的操作方式
    - 在环境分支（`master`, `pre`, `test`, `dev`）直接修改代码
    - 多个人同事操作了同一个文件
    - 一个人很长时间没有提交代码
    - 修改之前没有更新最新代码
    - 擅自修改其它小伙伴的代码
- 减少冲突的操作方式
    - 避免在环境分支（`master`, `pre`, `test`, `dev`）修改代码
    - 先pull再修改，修改完需要提交add, commit, pull, push
    - 确保自己正在修改的文件是最新版本
    - 各自开发各自的功能模块
    - 下班前提交代码，上班时拉取最新代码
    - 不要擅自修改其它小伙伴的代码

## 撤销和回滚
如果开发过程中发现当前已经提交的版本有问题回滚到上一个版本或者指定版本。    
假如当前提交的版本2.0有问题，需要回退到版本1.0
<a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3d6fb611f1b6?w=1041&h=474&f=png&s=124060">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3d6fb611f1b6?w=1041&h=474&f=png&s=124060)</a>     
<a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3da60476130d?w=1023&h=336&f=png&s=101160">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3da60476130d?w=1023&h=336&f=png&s=101160)</a>


- 混合合并：仅重设暂存区，但是不重设工作区。这个模式是默认模式。回退到某个版本，只保留源码，回退`commit`和`add`信息     
- 软合并： 暂存区和工作区中的内容不作任何改变，仅仅把HEAD指向`commit`，退到某个版本，只回退了`commit`的信息。
- 强行合并：丢弃所有的暂存区和工作区改动过的工作副本，从`commit`以来在工作区中的任何改变都被丢弃，并把HEAD指向`commit`，彻底回退到某个版本，本地的源码也会变为上一个版本的内容（三思而后行）     

## 开发中突发紧急任务处理
如果在开发过程中突然接到一个线上bug或者当前项目其他紧急需求，但是又不想提交当前的修改内容，这个时候可以使用贮藏功能，把修改的内容贮藏起来，然后切换到其它的分支处理紧急任务，处理完后再切换到之前的功能分支，把贮藏的内容重新提取出来，继续开发。      
如果试图在为提交当前分支的修改内容是就切换分支去处理其它任务，会报一下错误
<a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3703236ebab6?w=1331&h=253&f=png&s=27834">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3703236ebab6?w=1331&h=253&f=png&s=27834)</a>         
所以需要先把修改内容贮藏起来
<a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e372eb537fd19?w=1337&h=540&f=png&s=141333">![](https://user-gold-cdn.xitu.io/2018/12/25/167e372eb537fd19?w=1337&h=540&f=png&s=141333)</a>      
贮藏成功后就会在贮藏列表看到刚刚贮藏的内容      
<a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3741cd3a7aa1?w=1362&h=597&f=png&s=171231">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3741cd3a7aa1?w=1362&h=597&f=png&s=171231)</a>      
如果开发完其它任务后，切换到之前的功能分支，只需要把之前贮藏的内容提取出来就可以继续开发，提取后最好同时删除这次贮藏        
<a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e3777ae6d4a50?w=1354&h=530&f=png&s=186286">![](https://user-gold-cdn.xitu.io/2018/12/25/167e3777ae6d4a50?w=1354&h=530&f=png&s=186286)</a>      
应用成功后就会在图谱上看到之前的未提交更改，同时之前的贮藏也会贮藏列表移除      
<a data-fancybox title="" href="https://user-gold-cdn.xitu.io/2018/12/25/167e37916cacb003?w=1345&h=496&f=png&s=130965">![](https://user-gold-cdn.xitu.io/2018/12/25/167e37916cacb003?w=1345&h=496&f=png&s=130965)</a>